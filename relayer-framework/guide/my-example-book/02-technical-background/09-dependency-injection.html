<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Compile-Time Dependency Injection - IBC Relayer Framework Guide</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../01-introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../02-technical-background.html"><strong aria-hidden="true">2.</strong> Technical Background</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../02-technical-background/01-simple-greeter.html"><strong aria-hidden="true">2.1.</strong> Simple Greeter</a></li><li class="chapter-item expanded "><a href="../02-technical-background/02-dynamic-typing.html"><strong aria-hidden="true">2.2.</strong> Comparison with Dynamic Typing</a></li><li class="chapter-item expanded "><a href="../02-technical-background/03-generic-context.html"><strong aria-hidden="true">2.3.</strong> Generic Context</a></li><li class="chapter-item expanded "><a href="../02-technical-background/04-error-context.html"><strong aria-hidden="true">2.4.</strong> Error Context</a></li><li class="chapter-item expanded "><a href="../02-technical-background/05-explicit-binding.html"><strong aria-hidden="true">2.5.</strong> Explicit Associated Type Binding</a></li><li class="chapter-item expanded "><a href="../02-technical-background/06-generic-person.html"><strong aria-hidden="true">2.6.</strong> Generic Person</a></li><li class="chapter-item expanded "><a href="../02-technical-background/07-programs-as-types.html"><strong aria-hidden="true">2.7.</strong> Programs as Types</a></li><li class="chapter-item expanded "><a href="../02-technical-background/08-context-implementation.html"><strong aria-hidden="true">2.8.</strong> Context Implementation</a></li><li class="chapter-item expanded "><a href="../02-technical-background/09-dependency-injection.html" class="active"><strong aria-hidden="true">2.9.</strong> Compile-Time Dependency Injection</a></li><li class="chapter-item expanded "><a href="../02-technical-background/10-component-composition.html"><strong aria-hidden="true">2.10.</strong> Component Composition</a></li><li class="chapter-item expanded "><a href="../02-technical-background/11-error-injection.html"><strong aria-hidden="true">2.11.</strong> Error Injection</a></li><li class="chapter-item expanded "><a href="../02-technical-background/12-multiple-bindings.html"><strong aria-hidden="true">2.12.</strong> Multiple Type Bindings</a></li><li class="chapter-item expanded "><a href="../02-technical-background/13-concrete-composition.html"><strong aria-hidden="true">2.13.</strong> Concrete Composition</a></li><li class="chapter-item expanded "><a href="../02-technical-background/14-multi-contexts.html"><strong aria-hidden="true">2.14.</strong> Multiple Context Implementations</a></li><li class="chapter-item expanded "><a href="../02-technical-background/15-generic-store.html"><strong aria-hidden="true">2.15.</strong> Generic Store</a></li><li class="chapter-item expanded "><a href="../02-technical-background/16-querier-consumer.html"><strong aria-hidden="true">2.16.</strong> Querier Consumer</a></li><li class="chapter-item expanded "><a href="../02-technical-background/17-selfless-components.html"><strong aria-hidden="true">2.17.</strong> Selfless Components</a></li><li class="chapter-item expanded "><a href="../02-technical-background/18-store-context-impl.html"><strong aria-hidden="true">2.18.</strong> Store Context Implementation</a></li><li class="chapter-item expanded "><a href="../02-technical-background/19-multi-context-impls.html"><strong aria-hidden="true">2.19.</strong> Multiple Context Implementations</a></li><li class="chapter-item expanded "><a href="../02-technical-background/20-caching-querier.html"><strong aria-hidden="true">2.20.</strong> Caching Querier</a></li><li class="chapter-item expanded "><a href="../02-technical-background/21-caching-app-context.html"><strong aria-hidden="true">2.21.</strong> Caching App Context</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">IBC Relayer Framework Guide</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        

                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="compile-time-dependency-injection"><a class="header" href="#compile-time-dependency-injection">Compile-Time Dependency Injection</a></h1>
<p>The <code>app_greeter</code> function above demonstrates a form of <em>dependency injection</em>
done at compile time. This is because for any code to use a type implementing
<code>Greeter&lt;Context&gt;</code>, they only need to know that <code>Context</code> implements
<code>ErrorContext</code> and <code>PersonContext</code>. But to make <code>SimpleGreeter</code> implement
<code>Greeter&lt;Context&gt;</code>, it also needs <code>Context</code> to implement <code>QueryPersonContext</code>.</p>
<p>When we return <code>SimpleGreeter</code> inside <code>app_greeter</code>, the Rust compiler would
figure out that <code>SimpleGreeter</code> requires <code>AppContext</code> to implement
<code>QueryPersonContext</code>. It would then try to automatically <em>resolve</em> the
dependency by searching for an implementation of <code>QueryPersonContext</code>
for <code>AppContext</code>. Upon finding the implementation, Rust &quot;binds&quot; that
implementation with <code>SimpleGreeter</code>, and return it as an existential
type that implements <code>Greeter&lt;AppContext&gt;</code>. As a result,
We can treat the type returned from <code>app_greeter</code> as an abstract type,
and &quot;forget&quot; the fact that <code>AppContext</code> implements <code>QueryPersonContext</code>.</p>
<p>This pattern of making use of Rust's trait system for depedency injection
efficiently solves the
<a href="https://tmandry.gitlab.io/blog/posts/2021-12-21-context-capabilities/">context and capabilities problem</a>
in Rust. Without it, we would have to rely on more exotic language features
that are not available in Rust, or resort to manual passing of dependencies
by hands.</p>
<p>For example, we could perform manual binding for an implementation similar
to <code>SimpleGreeter</code> as a purely generic function as follows:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span><span class="boring">trait NamedPerson {
</span><span class="boring">  fn name(&amp;self) -&gt; &amp;str;
</span><span class="boring">}
</span><span class="boring">
</span>fn make_simpler_greeter&lt;Context, PersonId, Person, Error&gt;(
  query_person: impl Fn(&amp;Context, &amp;PersonId) -&gt; Result&lt;Person, Error&gt;,
) -&gt; impl Fn(&amp;Context, &amp;PersonId) -&gt; Result&lt;(), Error&gt;
where
  Person: NamedPerson,
{
  move | context, person_id | {
    let person = query_person(context, person_id)?;
    println!(&quot;Hello, {}&quot;, person.name());
    Ok(())
  }
}
<span class="boring">}
</span></code></pre></pre>
<p>As we can see, the ad hoc function <code>make_simpler_greeter</code> that we defined is
much more verbose than the earlier trait-based implementation. We would
have to explicitly track 4 generic type parameters, and we would have to
manually pass in dependencies like <code>query_person</code> and return nested closures.</p>
<p>When we delegate the management of the context dependencies to Rust's trait
system, we can think of Rust making automatic binding of depedencies similar
to what's being done in the code above. The binding is not only automated,
but also much more efficient. Because the binding is done at compile time,
it allows Rust to perform any further optimization such as inlining the code.</p>
<p>As we will see later, the same resolution can be applied to <em>nested</em>
dependencies. Thanks to how the trait system works, we can specify
complex dependencies for our components, and have Rust figure out
how to stitch together the dependencies and construct the combined
components that we need.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../02-technical-background/08-context-implementation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../02-technical-background/10-component-composition.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../02-technical-background/08-context-implementation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../02-technical-background/10-component-composition.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        
        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3000/__livereload");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
